<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Duck Duck Go Search Allowlist</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css"
    />
  </head>

  <body>
    <main>
      <h1>Duck Duck Go Search Allowlist</h1>
      <section>
        <label>Query<input id="query" value="fever" /></label>
        <label
          >Sites (whitespace separated)<textarea id="sites" rows="6">
mayoclinic.org
clevelandclinic.org</textarea
          >
        </label>
        <a href="#" id="search_link" role="button">Search</a>
      </section>
      <section>
        <details>
          <summary>Advanced Features</summary>
          <label
            ><a href="https://en.wikipedia.org/wiki/Smart_bookmark"
              >Smart bookmark</a
            >
            URL<input id="bookmark"
          /></label>
          <label
            ><input id="assist" type="checkbox" />Disable AI Assistance</label
          >
          <label><input id="no_ads" type="checkbox" />Disable Ads</label>
        </details>
      </section>
    </main>
    <script>
      const update = () => {
        sites_list = sites.value.split(/[\n\t ]+/)
        sites_list = sites_list.filter(str => str.trim())
        sites_list = sites_list.map(s => `site:${s}`)
        sites_exp = `( ${sites_list.join(' || ')} )`
        let features = ''
        if (assist.checked) {
          features += 'assist=false&'
        }
        if (no_ads.checked) {
          features += 'k1=-1&'
        }
        base_url = encodeURI(
          `https://duckduckgo.com/?${features}q=${sites_exp}`,
        )
        bookmark.value = base_url + '+%s'
        search_link.href = base_url + '+' + encodeURIComponent(query.value)
      }

      sites.addEventListener('input', update)
      query.addEventListener('input', update)
      assist.addEventListener('input', update)
      no_ads.addEventListener('input', update)
      query.addEventListener('keyup', e => {
        if (e.key === 'Enter' || e.keyCode === 13) {
          search_link.click()
        }
      })

      bookmark.addEventListener('input', () => {
        sites_list = [
          ...bookmark.value.matchAll(/site(:|%3A)(.+?)(%|\)|\+)/g),
        ].map(i => i[2])
        sites.value = sites_list.join('\n')
      })

      update()
    </script>
  </body>
</html>
